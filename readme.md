# 文档管理系统

一个基于 PHP 和 SQLite 的简洁文档管理系统，支持 Markdown 文档管理、用户权限控制和响应式界面。

## 功能特性

- 📚 **Markdown 文档管理** - 支持 Markdown 格式文档的创建、编辑和管理
- 👥 **用户权限系统** - 管理员和普通用户角色区分
- 📱 **响应式设计** - 基于 Bootstrap 的响应式界面
- 🔍 **全文搜索** - 支持文档内容的全文搜索
- 🖼️ **文件上传** - 支持图片和附件上传
- 📊 **管理后台** - 完整的后台管理界面
- 📤 **多格式导出** - 支持 PDF、Markdown、HTML、PNG、JPG 格式导出
- 🎨 **代码高亮** - 支持多种编程语言的代码高亮显示
- 📋 **文档历史管理** - 支持文档版本历史查看和管理
- 🗑️ **文档回收站** - 支持已删除文档的恢复和永久删除管理

## 技术栈

- **后端**: PHP 8.2+
- **数据库**: SQLite 3
- **前端**: HTML5, CSS3, JavaScript
- **框架**: Bootstrap 5.3.0 (完全本地化)
- **编辑器**: Toast UI Editor (完全本地化)
- **Markdown解析**: Parsedown
- **图标**: Bootstrap Icons (完全本地化)
- **导出功能**: html2canvas (图片导出)、浏览器原生API (PDF导出)

## 快速开始

### 环境要求

- PHP 8.2 或更高版本
- SQLite 3 支持
- Web 服务器 (Apache/Nginx/PHP内置服务器)

### 安装步骤

1. **克隆项目**
   ```bash
   git clone [你的仓库地址]
   cd web_doc
   ```

2. **启动开发服务器**
   ```bash
   php -S localhost:8000
   ```

3. **访问系统**
   - 前台首页: http://localhost:8000
   - 管理后台: http://localhost:8000/admin
   - 默认管理员: admin/admin123

### 目录结构

```
web_doc/
├── admin/              # 管理后台
│   ├── documents/      # 文档管理
│   │   ├── view_his.php    # 文档历史查看页面
│   ├── dashboard.php   # 管理面板
│   ├── users.php       # 用户管理
│   └── settings.php    # 系统设置
├── assets/             # 本地化静态资源
│   ├── css/
│   │   ├── static/     # 本地化CSS文件
│   │   │   ├── bootstrap.min.css    # Bootstrap 5.3.0
│   │   │   ├── bootstrap-icons.min.css  # Bootstrap Icons
│   │   │   └── prism.min.css        # 代码高亮
│   ├── fonts/          # 本地化字体文件
│   │   ├── bootstrap-icons.woff2    # Bootstrap Icons字体
│   │   └── bootstrap-icons.woff     # Bootstrap Icons字体
│   ├── js/
│   │   └── static/     # 本地化JS文件
│   │       ├── bootstrap.bundle.min.js  # Bootstrap JS
│   │       ├── prism.min.js             # 代码高亮
│   │       └── prism-*.min.js           # 各语言代码高亮
│   ├── images/         # 图片资源
│   └── icons/          # 图标文件
├── database/           # SQLite数据库
├── includes/           # 核心功能文件
├── uploads/            # 上传文件
├── index.php          # 前台首页
├── config.php         # 配置文件
└── README.md          # 项目文档
```

## 资源本地化

本项目所有外部依赖资源已完全本地化，无需网络连接即可正常运行：

### 🎨 样式资源
- **Bootstrap 5.3.0**: 本地CSS文件 `assets/css/static/bootstrap.min.css`
- **Bootstrap Icons**: 本地字体文件 `assets/fonts/bootstrap-icons.woff2` 和 `assets/fonts/bootstrap-icons.woff`
- **Prism代码高亮**: 本地CSS文件 `assets/css/static/prism.min.css`

### 📜 脚本资源
- **Bootstrap JS**: 本地JS文件 `assets/js/static/bootstrap.bundle.min.js`
- **Prism代码高亮**: 本地JS文件 `assets/js/static/prism.min.js`
- **Toast UI Editor**: 本地JS文件

### 🗂️ 本地化优势
- ✅ **零外部依赖**: 完全离线运行
- ✅ **加载更快**: 本地资源无网络延迟
- ✅ **稳定性高**: 不受CDN服务影响
- ✅ **隐私安全**: 无外部资源请求

## 使用说明

### 管理员功能

1. **登录后台**: 访问 `/admin` 使用管理员账户登录
2. **文档管理**: 创建、编辑、删除文档
3. **用户管理**: 管理用户账户和权限
4. **系统设置**: 配置系统参数

### 普通用户功能

- 浏览公开文档
- 搜索文档内容
- 查看文档详情

### 导出功能

系统支持将文档导出为多种格式，提供完整的文档导出解决方案：

#### 支持的导出格式
- **📄 PDF** - 保留完整格式的高质量PDF文档
- **📝 Markdown** - 原始Markdown格式，便于二次编辑
- **🌐 HTML** - 响应式HTML网页，保持原有样式
- **🖼️ PNG** - 高分辨率图片格式，适合分享和展示
- **📸 JPG** - 标准图片格式，兼容性好

#### 导出特性
- **格式完整保留** - 保持Markdown格式、代码高亮、表格等
- **响应式适配** - 自动适配不同屏幕尺寸
- **图片内嵌** - 支持本地图片自动内嵌到导出文件
- **中文优化** - 完美支持中文文档导出
- **文件名智能** - 自动使用文档标题作为文件名

#### 使用方法
1. **打开文档** - 在前台页面打开任意文档
2. **点击导出** - 点击右上角的"导出"按钮
3. **选择格式** - 从下拉菜单中选择需要的格式
4. **下载文件** - 系统自动生成并下载对应格式的文件

#### 技术实现
- **PDF导出** - 使用浏览器原生打印功能，确保最佳兼容性
- **HTML导出** - 保留完整CSS样式和响应式布局
- **图片导出** - 使用html2canvas库实现高质量渲染
- **Markdown导出** - 直接输出原始Markdown源码

### 文档回收站管理

系统提供完整的文档回收站功能，支持已删除文档的恢复和永久删除管理，确保数据安全性和操作可追溯性。

#### 功能特性
- **软删除机制** - 文档删除后进入回收站，不会立即永久删除
- **权限分级管理** - 管理员可执行永久删除，普通用户仅能查看
- **批量操作** - 支持单个或批量文档的恢复和永久删除
- **详细记录** - 记录删除者、删除时间等完整信息
- **一键恢复** - 支持将文档恢复到删除前的状态
- **永久删除确认** - 二次确认机制防止误操作

#### 权限控制
- **管理员权限** - 可执行恢复和永久删除操作
- **普通用户权限** - 可查看回收站内容但无法操作
- **操作验证** - 后端严格权限检查确保数据安全

#### 操作步骤
1. **访问回收站** - 管理员登录后点击"文档回收站"
2. **查看列表** - 显示所有已删除文档的详细信息
3. **选择操作** - 对单个文档选择恢复或永久删除
4. **确认操作** - 系统弹出确认对话框防止误操作
5. **完成操作** - 操作成功后显示相应提示信息

#### 界面设计
- **列表展示** - 表格形式显示文档ID、标题、父文档、删除者、删除时间
- **操作按钮** - 直观的图标按钮：查看详情、恢复、永久删除
- **分页导航** - 支持大量文档的分页显示
- **状态提示** - 操作成功/失败的友好提示信息

#### 数据安全
- **软删除保护** - 文档删除后数据完整保留
- **权限验证** - 所有操作均需权限验证
- **事务处理** - 使用数据库事务确保操作一致性
- **日志记录** - 完整记录所有回收站操作

### 文档历史管理

系统提供完整的文档版本历史管理功能，支持查看文档的所有历史版本，便于追踪文档变更和恢复历史内容。

#### 功能特性
- **版本历史查看** - 完整显示文档的所有历史版本记录
- **内容对比** - 支持查看不同版本之间的内容差异
- **版本详情** - 每个版本包含创建时间、版本号、完整内容
- **一键恢复** - 支持一键恢复到任意历史版本
- **Markdown支持** - 历史版本内容支持完整Markdown格式渲染
- **响应式设计** - 移动端友好的历史版本查看界面

#### 使用场景
- **内容追踪** - 查看文档的完整变更历史
- **版本恢复** - 快速恢复到之前的某个版本
- **内容对比** - 对比不同版本之间的内容差异
- **协作记录** - 了解文档的编辑历史和修改者

#### 操作步骤
1. **查看历史** - 在文档详情页面点击"查看历史文档"按钮
2. **选择版本** - 在历史版本列表中选择需要查看的版本
3. **查看内容** - 左侧显示选中版本的完整内容
4. **返回最新** - 点击"返回最新版本"按钮回到当前版本

#### 界面设计
- **双栏布局** - 左侧显示历史版本内容，右侧显示版本列表
- **版本标签** - 清晰显示当前查看的版本号和创建时间
- **交互优化** - 点击版本按钮即可切换，无需页面刷新
- **平滑过渡** - 版本切换时的平滑内容更新效果

#### 技术实现
- **版本存储** - 每次文档更新自动创建新的历史版本记录
- **内容解析** - 使用自定义Markdown解析器渲染历史内容
- **性能优化** - 按需加载历史版本内容，减少初始加载时间
- **数据安全** - 历史版本数据与当前文档分离存储，确保数据完整性

### 文档删除逻辑

系统支持智能删除文档，自动处理子文档的层级和排序，保持排序位置稳定：

#### 文档删除逻辑
系统支持智能删除文档，自动处理子文档的层级和排序，保持排序位置稳定：

#### 删除规则
- **软删除机制**：删除文档时仅标记为已删除状态，不会从数据库中物理删除记录
- **状态标记**：使用`del_status`字段标记删除状态（0=正常，1=已删除），并记录删除时间
- **直接子文档处理**：仅处理被删除文档的直接子文档
- **孙文档保持**：子文档的子文档层级和排序保持不变
- **排序继承**：子文档继承被删除文档的排序值，避免位置重大变化
- **数据保留**：删除的文档及其版本历史和编辑日志都会完整保留，支持数据恢复

#### 删除场景

1. **删除顶级文档**
   - **父级调整**：直接子文档的父级设为null（成为顶级文档）
   - **排序继承**：子文档排序权重 = 被删除的父级顶级文档的排序值（所有子文档相同）

2. **删除非顶级文档**
   - **父级调整**：直接子文档的父级设为被删除文档的原父级
   - **排序继承**：子文档排序权重 = 被删除的父级文档的排序值（所有子文档相同）

#### 文档恢复功能
- **恢复机制**：管理员可通过数据库直接修改`del_status`字段来恢复被删除的文档
- **数据完整性**：恢复后的文档会保留所有版本历史和编辑记录
- **层级关系**：恢复时需注意文档的层级关系可能需要重新调整

#### 示例
- 删除顶级文档"PHP教程"（排序值=5），其子文档"基础语法"、"面向对象"等都将继承排序值5
- 删除非顶级文档"第1章"（排序值=2），其子文档"1.1节"、"1.2节"等都将继承排序值2

#### 优势
- **排序稳定**：子文档保持相对位置，避免重新排序
- **层级清晰**：子文档自动调整到合适的父级层级
- **事务安全**：使用数据库事务确保数据一致性
- **数据安全**：软删除机制防止误删，支持数据恢复

## 开发指南

### 数据库结构

- **users**: 用户表
- **documents**: 文档表

### 主要文件

- `includes/auth.php`: 用户认证
- `includes/DocumentTree.php`: 文档管理
- `config.php`: 系统配置

## 贡献指南

欢迎提交 Issue 和 Pull Request！

## 许可证

MIT License