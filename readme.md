# 文档管理系统

一个基于 PHP 和 SQLite 的简洁文档管理系统，支持 Markdown 文档管理、用户权限控制和响应式界面。

## 功能特性

- 📚 **Markdown 文档管理** - 支持 Markdown 格式文档的创建、编辑和管理
- 👥 **用户权限系统** - 管理员和普通用户角色区分
- 📱 **响应式设计** - 基于 Bootstrap 的响应式界面
- 🔍 **全文搜索** - 支持文档内容的全文搜索
- 🖼️ **文件上传** - 支持图片和附件上传
- 📊 **管理后台** - 完整的后台管理界面
- 📤 **多格式导出** - 支持 PDF、Markdown、HTML、PNG、JPG 格式导出
- 🎨 **代码高亮** - 支持多种编程语言的代码高亮显示
- 📋 **文档历史管理** - 支持文档版本历史查看和管理
- 🗑️ **文档回收站** - 支持已删除文档的恢复和永久删除管理

## 技术栈
- **后端**: PHP 8.2+ + SQLite
- **前端**: Lake Editor + Bootstrap 5.3
- **本地化**: 所有资源本地化部署
- **导出**: PDF/HTML/PNG多格式支持

## 快速开始

### 环境要求

- PHP 8.2 或更高版本
- SQLite 3 支持
- Web 服务器 (Apache/Nginx/PHP内置服务器)

### 安装步骤

1. **克隆项目**
   ```bash
   git clone [你的仓库地址]
   cd web_doc
   ```

2. **启动开发服务器**
   ```bash
   php -S localhost:8000
   ```

3. **访问系统**
   - 前台首页: http://localhost:8000
   - 管理后台: http://localhost:8000/admin
   - 默认管理员: admin/admin123

### 目录结构

```
web_doc/
├── admin/              # 管理后台
│   ├── documents/      # 文档管理
│   ├── doc_recycle/    # 文档回收站
│   ├── user/           # 用户管理
│   └── *.php           # 管理功能页面
├── assets/             # 本地化静态资源
├── database/           # SQLite数据库
├── includes/           # 核心功能文件
├── uploads/            # 上传文件
├── *.php              # 核心页面文件
└── README.md          # 项目文档
```

## 资源本地化

本项目所有外部依赖资源已完全本地化，无需网络连接即可正常运行：

### 🎨 样式资源
- **Bootstrap 5.3.0**: 本地CSS文件 `assets/css/static/bootstrap.min.css`
- **Bootstrap Icons**: 本地字体文件 `assets/fonts/bootstrap-icons.woff2` 和 `assets/fonts/bootstrap-icons.woff`
- **Prism代码高亮**: 本地CSS文件 `assets/css/static/prism.min.css`

### 📜 脚本资源
- **Bootstrap JS**: 本地JS文件 `assets/js/static/bootstrap.bundle.min.js`
- **Prism代码高亮**: 本地JS文件 `assets/js/static/prism.min.js`
- **Toast UI Editor**: 本地JS文件

### 🗂️ 本地化优势
- ✅ **零外部依赖**: 完全离线运行
- ✅ **加载更快**: 本地资源无网络延迟
- ✅ **稳定性高**: 不受CDN服务影响
- ✅ **隐私安全**: 无外部资源请求

## 使用说明

### 核心功能
- **文档管理**: 创建、编辑、删除、查看文档
- **版本控制**: 文档历史版本查看与恢复
- **回收站**: 已删除文档的恢复与永久删除
- **文件导出**: 支持PDF、HTML、Markdown、图片格式
- **用户权限**: 管理员与普通用户权限区分
- **全文搜索**: 快速查找文档内容
- **文件上传**: 支持图片和附件上传

### 操作流程
1. **管理员**: 登录后台 → 管理文档/用户 → 系统配置
2. **普通用户**: 浏览文档 → 搜索内容 → 导出所需格式
3. **文档操作**: 编辑 → 查看历史 → 导出/分享

#### 技术实现
- **版本存储** - 每次文档更新自动创建新的历史版本记录
- **内容解析** - 使用自定义Markdown解析器渲染历史内容
- **性能优化** - 按需加载历史版本内容，减少初始加载时间
- **数据安全** - 历史版本数据与当前文档分离存储，确保数据完整性

### 文档删除逻辑

系统支持智能删除文档，自动处理子文档的层级和排序，保持排序位置稳定：

#### 文档删除逻辑
系统支持智能删除文档，自动处理子文档的层级和排序，保持排序位置稳定：

#### 删除规则
- **软删除机制**：删除文档时仅标记为已删除状态，不会从数据库中物理删除记录
- **状态标记**：使用`del_status`字段标记删除状态（0=正常，1=已删除），并记录删除时间
- **直接子文档处理**：仅处理被删除文档的直接子文档
- **孙文档保持**：子文档的子文档层级和排序保持不变
- **排序继承**：子文档继承被删除文档的排序值，避免位置重大变化
- **数据保留**：删除的文档及其版本历史和编辑日志都会完整保留，支持数据恢复

#### 删除场景

1. **删除顶级文档**
   - **父级调整**：直接子文档的父级设为null（成为顶级文档）
   - **排序继承**：子文档排序权重 = 被删除的父级顶级文档的排序值（所有子文档相同）

2. **删除非顶级文档**
   - **父级调整**：直接子文档的父级设为被删除文档的原父级
   - **排序继承**：子文档排序权重 = 被删除的父级文档的排序值（所有子文档相同）

#### 文档恢复功能
- **恢复机制**：管理员可通过数据库直接修改`del_status`字段来恢复被删除的文档
- **数据完整性**：恢复后的文档会保留所有版本历史和编辑记录
- **层级关系**：恢复时需注意文档的层级关系可能需要重新调整

#### 示例
- 删除顶级文档"PHP教程"（排序值=5），其子文档"基础语法"、"面向对象"等都将继承排序值5
- 删除非顶级文档"第1章"（排序值=2），其子文档"1.1节"、"1.2节"等都将继承排序值2

#### 优势
- **排序稳定**：子文档保持相对位置，避免重新排序
- **层级清晰**：子文档自动调整到合适的父级层级
- **事务安全**：使用数据库事务确保数据一致性
- **数据安全**：软删除机制防止误删，支持数据恢复

## 开发指南

### 数据库结构

- **users**: 用户表
- **documents**: 文档表

### 主要文件

#### 用户认证与管理
- `includes/auth.php`: 用户认证和权限管理
- `includes/init.php`: 系统初始化配置
- `admin/user/index.php`: 用户列表管理页面
- `admin/user/add_user.php`: 添加新用户
- `admin/user/edit_user.php`: 编辑用户信息
- `admin/user/delete_user.php`: 删除用户

#### 文档管理
- `includes/DocumentTree.php`: 文档树处理和文档管理核心
- `admin/documents/index.php`: 文档列表管理
- `admin/documents/add.php`: 添加新文档
- `admin/documents/edit.php`: 编辑文档
- `admin/documents/delete.php`: 删除文档
- `admin/documents/view.php`: 查看文档详情
- `admin/documents/view_his.php`: 文档历史版本查看

#### 回收站管理
- `admin/doc_recycle/index.php`: 回收站列表
- `admin/doc_recycle/restore.php`: 文档恢复功能
- `admin/doc_recycle/permdel.php`: 永久删除功能
- `admin/doc_recycle/view.php`: 回收文档详情查看

#### 系统配置
- `config.php`: 系统配置文件
- `database/router.php`: 数据库路由配置
- `admin/settings.php`: 系统设置页面
- `admin/dashboard.php`: 管理面板首页

#### 前台功能
- `index.php`: 前台首页（文档浏览）
- `search.php`: 文档搜索功能
- `export.php`: 文档导出功能

## 待办事项 (To-Do)

### 🔧 功能增强计划

#### 编辑器升级
- [ ] **集成富文本编辑器** - 集成 [Lake Editor](https://github.com/lakejs/lake) 富文本编辑器，提供更丰富的文档编辑体验

#### 配置功能扩展
- [ ] **文档历史版本数量自定义** - 实现文档历史版本数量的自定义设置功能，允许管理员配置保留的历史版本数量
- [ ] **操作记录配置** - 开发文档操作记录最大条数的配置选项，支持自定义操作日志的存储上限
- [ ] **回收站管理优化** - 添加回收站文档保留天数的上限设置功能，支持自动清理过期回收文档

## 贡献指南

欢迎提交 Issue 和 Pull Request！

## 许可证

MIT License