# 📋 核心功能操作与数据变更逻辑

## 🎯 文档ID分配机制

### 🔢 文档ID管理表结构
```sql
CREATE TABLE document_id_apportion (
    document_id INTEGER PRIMARY KEY AUTOINCREMENT,
    usage_status INTEGER DEFAULT 0 CHECK (usage_status IN (0, 1, 2, 3)),
    created_by INTEGER NOT NULL,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (created_by) REFERENCES users(id) ON DELETE CASCADE
);
```

### 📊 使用状态说明
| 状态值 | 状态说明 | 描述 |
|--------|---------|------|
| 0 | 未分配 | ID已生成但未分配给任何文档 |
| 1 | 已分配 | ID已分配给文档但未使用 |
| 2 | 已使用 | ID已被文档使用 |
| 3 | 已回收 | ID曾被使用但文档已删除 |

### ⚙️ 分配流程
1. **预生成ID** - 页面加载时预生成document_id并标记为已分配
2. **防重复机制** - 3秒内禁止重复生成，防止快速刷新
3. **会话存储** - 将预生成的ID保存在session中供后续使用
4. **提交确认** - 表单提交时将ID标记为已使用

### 🔄 核心分配函数
```php
function get_next_available_document_id() {
    $db = get_db();
    
    // 查找可用的ID（状态为0或3）
    $stmt = $db->query("SELECT document_id FROM document_id_apportion 
                       WHERE usage_status IN (0, 3) ORDER BY document_id ASC LIMIT 1");
    $available_id = $stmt->fetchColumn();
    
    if ($available_id) {
        return $available_id;
    }
    
    // 如果没有可用ID，创建新的ID
    $stmt = $db->prepare("INSERT INTO document_id_apportion (created_by) VALUES (?)");
    $stmt->execute([$_SESSION['user_id'] ?? 1]);
    return $db->lastInsertId();
}
```

## 📝 文档添加功能

### ➕ 添加流程
1. **权限验证** - 检查用户登录状态和操作权限
2. **ID预分配** - 预生成document_id并标记为已分配
3. **表单处理** - 接收并验证用户输入数据
4. **数据插入** - 将文档数据插入documents表
5. **版本保存** - 创建初始版本记录
6. **状态更新** - 将document_id标记为已使用
7. **日志记录** - 记录创建操作日志

### 🗂️ 核心数据表
```sql
-- documents表结构
CREATE TABLE documents (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    document_id INTEGER,          -- 对外显示的文档ID
    title TEXT NOT NULL,          -- 文档标题
    content TEXT,                 -- 文档内容
    parent_id INTEGER,           -- 父文档ID
    sort_order INTEGER DEFAULT 0, -- 排序权重
    user_id INTEGER DEFAULT 1,   -- 创建用户
    is_public INTEGER DEFAULT 1,  -- 是否公开
    tags TEXT,                   -- 标签
    created_at TEXT DEFAULT CURRENT_TIMESTAMP,
    updated_at TEXT DEFAULT CURRENT_TIMESTAMP,
    del_status INTEGER DEFAULT 0, -- 删除状态
    is_formal INTEGER DEFAULT 0,  -- 是否正式文档
    update_code TEXT             -- 更新标识码
);
```

## ✏️ 文档编辑功能

### 🔄 编辑流程
1. **变更检测** - 精确比较新旧数据的差异
2. **标准化处理** - 统一处理NULL值、空白字符、换行符
3. **版本控制** - 仅在内容有变更时保存新版本
4. **更新文档** - 更新documents表中的数据
5. **日志记录** - 详细记录每个字段的变更情况

### 🔍 变更检测算法
```php
$normalize = function($value) {
    if ($value === null || $value === false) {
        return '';
    }
    $value = trim((string)$value);
    $value = str_replace(["\r\n", "\r"], "\n", $value);
    $value = preg_replace('/[ \t]+$/m', '', $value);
    $value = preg_replace('/\n{3,}/', "\n\n", $value);
    return $value;
};

// 精确比较各字段变更
$changes['op_title'] = ($normalize($old_document['title']) !== $normalize($title)) ? 1 : 0;
$changes['op_content'] = ($normalize($old_document['content']) !== $normalize($content)) ? 1 : 0;
```

## 📚 历史版本管理

### 🗃️ 版本表结构
```sql
CREATE TABLE documents_version (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    document_id INTEGER NOT NULL,     -- 关联文档ID
    title TEXT NOT NULL,              -- 版本标题
    content TEXT,                     -- 版本内容
    tags TEXT,                        -- 版本标签
    version_number INTEGER NOT NULL,  -- 版本号
    created_by INTEGER NOT NULL,       -- 创建用户
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    update_code TEXT                  -- 更新标识码
);
```

### 🔄 版本保存逻辑
1. **变更触发** - 仅在title、content、tags字段实际变更时保存
2. **版本号递增** - 自动计算下一个版本号
3. **完整保存** - 保存文档的完整状态快照
4. **关联记录** - 使用update_code关联相关操作记录

### ⏪ 版本回滚功能
1. **选择版本** - 用户选择要回滚的历史版本
2. **数据恢复** - 将选定版本的数据恢复到当前文档
3. **新版本创建** - 创建回滚操作的新版本记录
4. **事务保证** - 使用数据库事务确保数据一致性
5. **日志记录** - 记录回滚操作详情

## 📊 操作记录系统

### 📝 编辑日志表结构
```sql
CREATE TABLE edit_log (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    document_id INTEGER NOT NULL,        -- 关联文档ID
    user_id INTEGER NOT NULL,             -- 操作用户
    action TEXT NOT NULL CHECK (action IN 
        ('create', 'update', 'delete', 'rollback', 'restore')),
    -- 变更状态字段
    op_title INTEGER DEFAULT 0 CHECK (op_title IN (0, 1)),
    op_content INTEGER DEFAULT 0 CHECK (op_content IN (0, 1)),
    op_tags INTEGER DEFAULT 0 CHECK (op_tags IN (0, 1)),
    op_parent INTEGER DEFAULT 0 CHECK (op_parent IN (0, 1)),
    op_corder INTEGER DEFAULT 0 CHECK (op_corder IN (0, 1)),
    op_public INTEGER DEFAULT 0 CHECK (op_public IN (0, 1, 2)),
    op_formal INTEGER DEFAULT 0 CHECK (op_formal IN (0, 1, 2)),
    created_at DATETIME DEFAULT (datetime('now', 'localtime')),
    update_code TEXT                      -- 更新标识码
);
```

### 🔍 操作类型说明
| 操作类型 | 描述 | 变更检测 |
|----------|------|---------|
| create | 创建文档 | 不适用 |
| update | 更新文档 | 详细字段变更 |
| delete | 删除文档 | 不适用 |
| rollback | 版本回滚 | 不适用 |
| restore | 恢复文档 | 不适用 |

### 📋 公开状态变更
| 状态值 | 描述 |
|--------|------|
| 0 | 无变更 |
| 1 | 设为公开 |
| 2 | 设为私有 |

## 🗑️ 软删除与恢复

### ⚡ 软删除机制
1. **状态标记** - 将del_status设置为1标记为已删除
2. **时间记录** - 记录删除时间deleted_at
3. **数据保留** - 保留所有文档数据和关联记录
4. **权限控制** - 只有管理员可以永久删除

### 🔄 父ID与排序规则变化
#### 📋 删除时的层级处理
1. **子文档继承** - 被删除文档的直接子文档将继承其父级关系
2. **排序权重继承** - 子文档继承被删除文档的排序值，保持相对位置稳定
3. **层级提升** - 子文档自动提升到被删除文档的原父级层级

#### 📊 删除处理示例
| 操作前状态 | 操作 | 操作后状态 |
|------------|------|------------|
| 父文档A(排序=5) → 子文档B | 删除文档A | 子文档B继承排序=5，提升到顶级 |
| 文档X(排序=2) → 子文档Y | 删除文档X | 子文档Y继承排序=2，提升到文档X的原父级 |

#### ⚖️ 排序规则特点
- **稳定性** - 子文档保持相对排序位置，避免重新排序混乱
- **继承性** - 排序值由被删除文档传递给子文档
- **事务性** - 使用数据库事务确保数据一致性

### 🔄 恢复流程
1. **状态重置** - 将del_status重置为0
2. **时间清空** - 清空deleted_at字段
3. **层级保持** - 恢复时保持原有的父ID和排序值不变
4. **日志记录** - 记录恢复操作
5. **事务保证** - 使用事务确保操作原子性

#### 📋 恢复时的层级处理
- **父ID保留** - 恢复时文档的parent_id保持不变
- **排序值保留** - 恢复时文档的sort_order保持不变
- **层级关系恢复** - 完全恢复到删除前的层级结构状态

#### ⚠️ 注意事项
- 如果被删除文档的父文档也被删除，恢复后可能需要手动调整层级关系
- 排序值在恢复后保持不变，确保文档在列表中的位置稳定

### 💾 永久删除
1. **物理删除** - 从数据库彻底删除记录
2. **关联清理** - 删除相关的版本记录和日志
3. **ID回收** - 将document_id状态标记为已回收
4. **空间释放** - 释放存储空间

## 🔄 文档回滚机制

### ⏪ 回滚流程
1. **版本选择** - 用户选择要回滚的历史版本
2. **数据提取** - 从documents_version表获取版本数据
3. **版本创建** - 创建新的版本记录（版本号+1）
4. **文档更新** - 更新documents表为回滚版本内容
5. **日志记录** - 记录回滚操作
6. **事务保证** - 确保所有操作原子性

### 🔗 数据一致性
- **update_code** - 使用唯一标识码关联相关操作
- **事务处理** - 数据库事务确保操作完整性
- **版本控制** - 严格的版本号管理

## 📈 性能优化策略

### ⚡ 查询优化
- **索引创建** - 在关键字段创建索引提高查询速度
- **分页机制** - 支持大量数据的分页显示
- **缓存策略** - 缓存文档树结构和热门搜索结果

### 💾 存储优化
- **变更检测** - 仅在数据实际变更时保存版本
- **标准化处理** - 减少不必要的版本记录
- **定期清理** - 清理无用的临时数据和日志

## 🔒 安全与权限

### 👥 用户权限
| 用户角色 | 文档操作 | 用户管理 | 系统设置 |
|----------|----------|----------|----------|
| 管理员 | ✅ 完全权限 | ✅ 完全权限 | ✅ 完全权限 |
| 编辑者 | ✅ 自己的文档 | ❌ 禁止 | ❌ 禁止 |
| 访客 | ❌ 只读权限 | ❌ 禁止 | ❌ 禁止 |

### 🛡️ 安全特性
- **输入验证** - 前后端双重数据验证
- **SQL防注入** - PDO预处理语句
- **XSS防护** - 输出内容转义
- **会话管理** - 安全的会话处理机制

---
*最后更新: 2024年*